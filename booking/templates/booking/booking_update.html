{% extends "base.html" %}
{% block content %}
<div class="max-w-lg mx-auto mt-10 bg-white shadow-md rounded-xl p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Edit Booking</h1>
  <hr class="mb-6">

  <form id="bookingForm" method="post" class="space-y-5">
    {% csrf_token %}

    {% for field in form %}
      <div>
        <label for="{{ field.id_for_label }}" class="block text-gray-700 font-semibold mb-1">
          {{ field.label }}
        </label>
        {{ field }}
        <p class="error text-red-500 text-sm mt-1"></p>
      </div>
    {% endfor %}

    <!-- Tombol aksi -->
    <div class="flex items-center justify-between mt-6">
      <button type="submit" id="submitBtn"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition">
        Update
      </button>
      <a href="{% url 'booking:booking_dashboard' %}"
         class="text-gray-600 hover:text-gray-800 font-medium transition">
         Batal
      </a>
    </div>
  </form>

  <!-- Alert sukses/gagal -->
  <div id="alertBox" class="hidden mt-4 text-center p-3 rounded-md"></div>
</div>

<!-- Styling input agar sesuai dengan Tailwind -->
<style>
  input, select, textarea {
    @apply w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-green-500 focus:border-green-500;
  }
  .hidden { display: none; }
</style>

<!-- âš¡ AJAX Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('bookingForm');
  const alertBox = document.getElementById('alertBox');
  const submitBtn = document.getElementById('submitBtn');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    alertBox.classList.add('hidden');

    // Nonaktifkan tombol selama proses
    submitBtn.disabled = true;
    submitBtn.textContent = 'Menyimpan...';

    const formData = new FormData(form);

    try {
      const response = await fetch(window.location.href, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken,
        },
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        alertBox.textContent = data.message || 'Booking berhasil diperbarui!';
        alertBox.className = 'block bg-green-100 text-green-700 border border-green-400 rounded-md p-3 mt-4 text-center';
        
        // redirect ke dashboard user
        setTimeout(() => {
          window.location.href = "{% url 'booking:booking_dashboard' %}";
        }, 1200);
      } else {
        document.querySelectorAll('.error').forEach(e => e.textContent = '');
        if (data.errors) {
          for (const [field, messages] of Object.entries(data.errors)) {
            const errorEl = form.querySelector(`[name="${field}"]`)?.closest('div')?.querySelector('.error');
            if (errorEl) errorEl.textContent = messages.join(', ');
          }
        }
        alertBox.textContent = 'Terjadi kesalahan. Periksa kembali inputmu.';
        alertBox.className = 'block bg-red-100 text-red-700 border border-red-400 rounded-md p-3 mt-4 text-center';
      }
    } catch (error) {
      alertBox.textContent = 'Gagal menghubungi server.';
      alertBox.className = 'block bg-red-100 text-red-700 border border-red-400 rounded-md p-3 mt-4 text-center';
    } finally {
      // Aktifkan lagi tombol
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update';
    }
  });
});
</script>
{% endblock %}
