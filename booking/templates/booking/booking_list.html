{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-100 py-10">
  <div class="max-w-6xl mx-auto px-4">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">List Lapangan</h1>
    </div>

    <!-- üîç FILTER + SEARCH SECTION -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Filter & Pencarian Lapangan</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- Search -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Cari Lapangan</label>
          <input type="text" id="filterSearch" placeholder="Cari nama atau lokasi..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
          <select id="filterKategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            <option value="">Semua</option>
            <option value="futsal">Futsal</option>
            <option value="basket">Basket</option>
            <option value="badminton">Badminton</option>
            <option value="tenis">Tenis</option>
            <option value="voli">Voli</option>
            <option value="lainnya">Lainnya</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Harga Min</label>
          <input type="number" id="filterHargaMin" placeholder="Min harga..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Harga Max</label>
          <input type="number" id="filterHargaMax" placeholder="Max harga..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button id="applyFilter" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
          Terapkan
        </button>
        <button id="clearFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition">
          Reset
        </button>
      </div>
    </div>

    <!-- üì¶ LAPANGAN LIST -->
    <div id="lapangan-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for lap in lapangan_list %}
      <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl transition">
        {% if lap.foto %}
          <img src="{{ lap.foto.url }}" alt="{{ lap.nama }}" class="w-full h-48 object-cover">
        {% else %}
          <div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 italic">
            Tidak ada foto
          </div>
        {% endif %}
        <div class="p-5">
          <h2 class="text-xl font-semibold text-gray-800 mb-1">{{ lap.nama }}</h2>
          <p class="text-sm text-gray-500 mb-2">{{ lap.kategori }} ‚Ä¢ {{ lap.lokasi }}</p>
          <p class="text-gray-700 font-medium">Rp {{ lap.harga_per_jam }} / jam</p>
          <p class="text-sm text-gray-500 mt-2">‚è∞ {{ lap.jam_buka }} - {{ lap.jam_tutup }}</p>

          <div class="mt-4 flex justify-between items-center">
            <!-- ‚úÖ Diperbaiki: Tambahkan tombol Add to Wishlist -->
            <a href="{% url 'wishlist:add_to_wishlist' lap.iklan_set.first.id %}"
               class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow transition">
              Add to Wishlist
            </a>

            <!-- ‚úÖ Diperbaiki: Syntax url Django yang benar -->
            <a href="{% url 'booking:booking_create' lap.id_lapangan %}"
               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow transition">
              Pesan Sekarang
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ‚ö° SCRIPT -->
<script>
function loadLapangan(filters = {}) {
  let url = window.location.pathname;
  const params = new URLSearchParams();

  if (filters.search) params.append('search', filters.search);
  if (filters.kategori) params.append('kategori', filters.kategori);
  if (filters.harga_min) params.append('harga_min', filters.harga_min);
  if (filters.harga_max) params.append('harga_max', filters.harga_max);

  if (params.toString()) url += '?' + params.toString();

  fetch(url, { headers: {"X-Requested-With": "XMLHttpRequest"} })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("lapangan-container");
      container.innerHTML = "";

      if (data.lapangan_list.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Tidak ada lapangan yang sesuai.</div>';
        return;
      }

      data.lapangan_list.forEach(lap => {
        const card = `
        <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl transition">
          ${lap.foto_url ? `<img src="${lap.foto_url}" alt="${lap.nama}" class="w-full h-48 object-cover">` 
                         : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 italic">Tidak ada foto</div>`}
          <div class="p-5">
            <h2 class="text-xl font-semibold text-gray-800 mb-1">${lap.nama}</h2>
            <p class="text-sm text-gray-500 mb-2">${lap.kategori} ‚Ä¢ ${lap.lokasi}</p>
            <p class="text-gray-700 font-medium">Rp ${lap.harga_per_jam} / jam</p>
            <p class="text-sm text-gray-500 mt-2">‚è∞ ${lap.jam_buka.substring(0,5)} - ${lap.jam_tutup.substring(0,5)}</p>
            <div class="mt-4 flex justify-between items-center">
              <a href="/wishlist/add/${lap.iklan_id}/"
                 class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow transition">
                Add to Wishlist
              </a>
              <a href="/booking/create/${lap.id_lapangan}/"
                 class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow transition">
                Pesan Sekarang
              </a>
            </div>
          </div>
        </div>`;
        container.insertAdjacentHTML("beforeend", card);
      });
    });
}

// Tombol Apply Filter
document.getElementById("applyFilter").addEventListener("click", function() {
  const filters = {
    search: document.getElementById("filterSearch").value,
    kategori: document.getElementById("filterKategori").value,
    harga_min: document.getElementById("filterHargaMin").value,
    harga_max: document.getElementById("filterHargaMax").value
  };
  loadLapangan(filters);
});

// Tombol Reset
document.getElementById("clearFilter").addEventListener("click", function() {
  document.getElementById("filterSearch").value = "";
  document.getElementById("filterKategori").value = "";
  document.getElementById("filterHargaMin").value = "";
  document.getElementById("filterHargaMax").value = "";
  loadLapangan();
});

// Enter key = search langsung
document.getElementById("filterSearch").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    document.getElementById("applyFilter").click();
  }
});

document.addEventListener("DOMContentLoaded", function() {
  loadLapangan();
});
</script>
{% endblock %}
