{% extends "base.html" %}

{% block content %}
<div class="max-w-lg mx-auto mt-10 bg-white shadow-lg rounded-xl p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Buat Booking Baru</h1>

  {% if lapangan_terpilih %}
  <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
    <h2 class="text-lg font-semibold text-green-800">Lapangan yang Dipesan:</h2>
    <p class="text-gray-700 mt-1 font-medium">{{ lapangan_terpilih.nama }}</p>
    <p class="text-gray-600 text-sm">
      Harga per jam: <strong>Rp {{ lapangan_terpilih.harga_per_jam }}</strong><br>
      Jam buka: <strong>{{ lapangan_terpilih.jam_buka }}</strong><br>
      Jam tutup: <strong>{{ lapangan_terpilih.jam_tutup }}</strong>
    </p>
  </div>
  {% endif %}

  <form id="bookingForm" class="space-y-5" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input
      type="hidden"
      id="id_lapangan"
      name="lapangan"
      value="{{ lapangan_terpilih.id_lapangan }}"
      data-harga="{{ lapangan_terpilih.harga_per_jam }}"
    >

    <div class="flex flex-col">
      <label for="id_tanggal" class="block text-gray-700 font-semibold mb-1">Tanggal</label>
      <input
        type="date"
        name="tanggal"
        id="id_tanggal"
        required
        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-300"
      >
    </div>

    <div class="flex flex-col">
      <label for="id_jam_mulai" class="block text-gray-700 font-semibold mb-1">Jam Mulai</label>
      <select
        name="jam_mulai"
        id="id_jam_mulai"
        required
        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-300"
      >
      </select>
    </div>

    <div class="flex flex-col">
      <label for="id_jam_selesai" class="block text-gray-700 font-semibold mb-1">Jam Selesai</label>
      <select
        name="jam_selesai"
        id="id_jam_selesai"
        required
        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-300"
      >
      </select>
    </div>

    <div class="flex flex-col">
      <label for="id_total_harga" class="block text-gray-700 font-semibold mb-1">Total Harga</label>
      <input
        type="text"
        name="total_harga"
        id="id_total_harga"
        readonly
        class="border border-gray-300 rounded-md px-3 py-2 bg-gray-100 cursor-not-allowed"
      >
    </div>

    <button
      type="submit"
      class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition"
    >
      Simpan Booking
    </button>
  </form>
</div>

<div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" id="my-modal">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Booking Berhasil!</h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500">
          Booking Anda telah berhasil dibuat. Terima kasih!
        </p>
      </div>
      <div class="items-center px-4 py-3">
        <button id="modalCloseBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const tanggalInput = document.getElementById("id_tanggal");
  const jamMulai = document.getElementById("id_jam_mulai");
  const jamSelesai = document.getElementById("id_jam_selesai");
  const totalHargaInput = document.getElementById("id_total_harga");
  const lapanganHidden = document.getElementById("id_lapangan");

  // ========== BATAS TANGGAL ==========
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  tanggalInput.min = `${yyyy}-${mm}-${dd}`;

  // ========== BATAS JAM (Isi Select Option) ==========
  const jamBuka = "{{ lapangan_terpilih.jam_buka|time:'H' }}";
  const jamTutup = "{{ lapangan_terpilih.jam_tutup|time:'H' }}";

  function isiJamSelect() {
    jamMulai.innerHTML = "";
    jamSelesai.innerHTML = "";
    for (let i = parseInt(jamBuka); i < parseInt(jamTutup); i++) {
      const val = i.toString().padStart(2, "0") + ":00:00";
      
      const optMulai = document.createElement("option");
      optMulai.value = val;
      optMulai.textContent = `${i}:00`;
      jamMulai.appendChild(optMulai);

      const optSelesai = document.createElement("option");
      optSelesai.value = val;
      optSelesai.textContent = `${i}:00`;
      jamSelesai.appendChild(optSelesai);
    }
  }
  isiJamSelect();

  // ========== HITUNG TOTAL (Visual Only) ==========
  function hitungTotal() {
    const mulai = parseInt(jamMulai.value.split(":")[0]);
    const selesai = parseInt(jamSelesai.value.split(":")[0]);
    const harga = parseInt(lapanganHidden.dataset.harga);
    
    // Validasi visual di kolom total harga
    if (selesai > mulai) {
        totalHargaInput.value = (selesai - mulai) * harga;
    } else {
        totalHargaInput.value = "Jam tidak valid";
    }
  }
  [jamMulai, jamSelesai].forEach(el => el.addEventListener("change", hitungTotal));

  // ========== CEK KETERSEDIAAN (FETCH API) ==========
  tanggalInput.addEventListener("change", function() {
    const tanggal = this.value;
    const lapanganId = lapanganHidden.value;
    if (!tanggal) return;

    fetch(`/booking/api/booked/${lapanganId}/${tanggal}/`)
      .then(res => res.json())
      .then(data => {
        const booked = data.jam_terpakai.map(j => j.toString().padStart(2, "0") + ":00:00");

        for (let opt of jamMulai.options) opt.disabled = booked.includes(opt.value);
        for (let opt of jamSelesai.options) opt.disabled = booked.includes(opt.value);
      })
      .catch(err => console.error(err));
  });

  // ========== SUBMIT HANDLER ==========
  const bookingForm = document.getElementById("bookingForm");
  const successModal = document.getElementById("successModal");
  const modalCloseBtn = document.getElementById("modalCloseBtn");

  bookingForm.addEventListener("submit", function(e) {
    e.preventDefault();

    // 1. VALIDASI JAM SEBELUM KIRIM
    const mulaiVal = parseInt(jamMulai.value.split(":")[0]);
    const selesaiVal = parseInt(jamSelesai.value.split(":")[0]);

    // Jika Jam Mulai >= Jam Selesai, tampilkan Alert dan Stop
    if (mulaiVal >= selesaiVal) {
        alert("Pilihan jam tidak valid");
        return; // Hentikan eksekusi di sini
    }

    // 2. PERSIAPAN KIRIM DATA
    const formData = new FormData(this);

    // 3. KIRIM KE SERVER
    fetch(window.location.href, {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Tampilkan Modal Sukses jika berhasil
        successModal.classList.remove("hidden");
      } else {
        // Tampilkan Alert Error jika validasi Backend gagal
        console.error("Form errors:", data.errors);
        alert("Terjadi kesalahan: " + JSON.stringify(data.errors));
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Terjadi kesalahan saat mengirim form.");
    });
  });

  // ========== TUTUP MODAL & REDIRECT ==========
  modalCloseBtn.addEventListener("click", function() {
    successModal.classList.add("hidden");
    // Redirect ke dashboard atau halaman lain setelah OK
    window.location.href = "{% url 'booking:booking_dashboard' %}";
  });
});
</script>
{% endblock %}